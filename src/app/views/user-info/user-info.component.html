<!-- Màng mờ -->
<div *ngIf="activeModal" class="overlay"></div>

<div class="modal" *ngIf="activeModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">{{ getModalTitle() }}</h2>
            <button type="button" (click)="closeModal()" class="btn-close" aria-label="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <!-- Phần hiển thị thông tin người dùng -->
        <div *ngIf="activeModal === 'updateInfo'">
            <form (ngSubmit)="onSubmitUpdateInfo()">
                <label for="ho_va_ten">Họ và tên</label>
                <input type="text" id="ho_va_ten" [(ngModel)]="userInfo.ho_va_ten" name="ho_va_ten" required>

                <label for="email">Email</label>
                <input type="email" id="email" [(ngModel)]="userInfo.email" name="email" required>

                <label for="so_dien_thoai">Số điện thoại</label>
                <input type="text" id="so_dien_thoai" [(ngModel)]="userInfo.so_dien_thoai" name="so_dien_thoai" required>

                <label for="dia_chi">Địa chỉ</label>
                <input type="text" id="dia_chi" [(ngModel)]="userInfo.dia_chi" name="dia_chi" required>

                <button type="submit" class="btn-submit">
                    <i class="fas fa-save"></i> Lưu
                </button>
            </form>
        </div>

        <!-- Phần đổi mật khẩu -->
        <div *ngIf="activeModal === 'changePassword'">
            <form (ngSubmit)="onSubmitChangePassword()">
                <label for="currentPassword">Mật khẩu hiện tại</label>
                <input type="password" id="currentPassword" [(ngModel)]="passwords.currentPassword" name="currentPassword" required>

                <label for="newPassword">Mật khẩu mới</label>
                <input type="password" id="newPassword" [(ngModel)]="passwords.newPassword" name="newPassword" required>

                <label for="confirmPassword">Xác nhận mật khẩu</label>
                <input type="password" id="confirmPassword" [(ngModel)]="passwords.confirmPassword" name="confirmPassword" required>

                <button type="submit" class="btn-submit">
                    <i class="fas fa-check"></i> Đổi mật khẩu
                </button>
            </form>
        </div>

        <!-- Phần hiển thị lịch sử đơn hàng -->
        <div *ngIf="activeModal === 'orderHistory'">
            <div *ngIf="activeModal === 'orderHistory'">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>ID Đơn hàng</th>
                            <th>Tên sản phẩm</th>
                            <th>Ảnh</th>
                            <th>Số lượng</th>
                            <th>Màu sắc</th>
                            <th>Kích thước</th>
                            <th>Tổng tiền</th>
                            <th>Ngày mua</th>
                            <th>Trạng thái</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        <ng-container *ngFor="let order of orderHistory; let i = index">
                            <ng-container *ngFor="let product of order.products; let j = index">
                                <tr>
                                    <!-- Only show the sequence number (STT) and order details in the first row -->
                                    <td *ngIf="j === 0" [attr.rowspan]="order.products.length">{{ i + 1 }}</td>
                                    <td *ngIf="j === 0" [attr.rowspan]="order.products.length">{{ order.id_don_hang }}</td>
                                    <td style="max-width: 200px">{{ product.tenSanPham }}</td>
                                    <td>
                                        <img [src]="product.anhSanPham || 'default-image-url.jpg'" alt="{{ product.tenSanPham }}" width="100px" height="100px" />
                                    </td>
                                    <td>{{ product.soLuong }}</td>
                                    <td>{{ product.mau_sac }}</td>
                                    <td>{{ product.kich_thuoc }}</td>
                                    <td>{{ product.tongTien | currency:'VND' }}</td>
                                    <!-- Only show the order date, status, and action button in the first row -->
                                    <td *ngIf="j === 0" [attr.rowspan]="order.products.length">{{ order.ngay_mua | date: 'dd/MM/yyyy' }}</td>
                                    <td *ngIf="j === 0" [attr.rowspan]="order.products.length">
                                        {{ order.trang_thai === 'cho_xu_ly' ? 'Chờ xử lý' : order.trang_thai === 'da_xac_nhan' ? 'Đã xác nhận' : order.trang_thai === 'da_giao' ? 'Đã giao' : order.trang_thai === 'da_huy' ? 'Đã hủy' : order.trang_thai }}
                                    </td>
                                    <td *ngIf="j === 0" [attr.rowspan]="order.products.length">
                                        <button (click)="viewOrderDetails(order.id_don_hang)" class="show">Xem chi tiết</button>
                                    </td>
                                </tr>
                            </ng-container>
                        </ng-container>
                    </tbody>
                </table>


            </div>

            <div *ngIf="showOrder" class="order-details">
                <button (click)="closeOrderDetails()" class="close-button">Đóng</button>
                <h3>Thông tin chi tiết đơn hàng {{ selectedOrderDetails?.id_don_hang }}</h3>

                <table>
                    <thead>
                        <tr>
                            <th>STT</th>
                            <th>Tên sản phẩm</th>
                            <th>Ảnh sản phẩm</th>
                            <th>Màu sắc</th>
                            <th>Kích thước</th>
                            <th>Số lượng</th>
                            <th>Tổng tiền</th>
                            <th>Ngày mua</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let product of selectedOrderDetails?.products; let i = index">
                            <td>{{ i + 1 }}</td>
                            <td>{{ product.tenSanPham }}</td>
                            <td>
                                <img [src]="product.anhSanPham || 'default-image-url.jpg'" alt="{{ product.tenSanPham }}" class="product-image" style="width: 100px; height: 100px;" />
                            </td>
                            <td>{{ product.mau_sac }}</td>
                            <td>{{ product.kich_thuoc }}</td>
                            <td>{{ product.soLuong }}</td>
                            <td>{{ product.tongTien | currency:'VND' }}</td>
                            <td>{{ selectedOrderDetails.ngay_mua | date: 'dd/MM/yyyy' }}</td>
                            <td>
                                {{ selectedOrderDetails.trang_thai === 'cho_xu_ly' ? 'Chờ xử lý' : selectedOrderDetails.trang_thai === 'da_xac_nhan' ? 'Đã xác nhận' : selectedOrderDetails.trang_thai === 'dang-giao' ? 'Đang vận chuyển' : selectedOrderDetails.trang_thai === 'da_giao'
                                ? 'Đã giao' : selectedOrderDetails.trang_thai === 'da_huy' ? 'Đã hủy' : product.trang_thai }}
                            </td>

                        </tr>
                    </tbody>
                </table>

                <div *ngIf="selectedOrderDetails.trang_thai === 'cho_xu_ly'">
                    <button (click)="cancelOrder(selectedOrderDetails.id_don_hang)" class="cancel-button">Hủy</button>
                </div>
            </div>


        </div>
    </div>
</div>
